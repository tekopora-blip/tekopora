<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Nova Requisição - Teko Porã</title>
  <style>
    body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 15px;
  padding: 16px;
  background-color: #f9fafb;
}

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #333;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #d0d0d0;
      font-size: 16px;
      box-sizing: border-box;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .info-box {
      background: #eef7ff;
      border: 1px solid #c7e0ff;
      border-radius: 6px;
      padding: 10px;
      font-size: 13px;
      color: #225588;
      margin-bottom: 10px;
    }

    .warning-box {
      background: #fff4e5;
      border: 1px solid #ffd8a8;
      border-radius: 6px;
      padding: 10px;
      font-size: 13px;
      color: #8a4b00;
      margin-top: 10px;
    }

    .warning-box a {
      color: #8a4b00;
      text-decoration: underline;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-primary {
      background-color: #667eea;
      color: #fff;
    }

    .btn-primary:disabled {
      background-color: #b0b7f3;
      cursor: not-allowed;
    }

    .rubrica-desc {
      font-size: 13px;
      color: #555;
      margin-top: 5px;
    }
@media (max-width: 600px) {
  body {
    padding: 10px;
  }

  .form-group {
    margin-bottom: 12px;
  }

  .info-box,
  .warning-box {
    font-size: 13px;
    padding: 8px;
  }

  .btn {
    width: 100%;      /* botão ocupar largura total no celular */
    text-align: center;
  }
}
  </style>
</head>
<body>

  <form id="formNovaRequisicao">
    <div class="info-box">
      Preencha os campos da requisição. A rubrica deve ser uma das já cadastradas no sistema. Caso não localize a rubrica desejada, será necessário solicitar o cadastro por e-mail para <strong>teko.pora@ifms.edu.br</strong>.
    </div>

    <div class="form-group">
      <label for="projeto">Projeto / Meta</label>
      <input type="text" id="projeto" name="projeto" required>
    </div>

    <!-- RUBRICA (CARREGA DO LOCALSTORAGE) -->
    <div class="form-group">
      <label for="rubricaSelect">Rubrica</label>
      <select id="rubricaSelect" name="rubrica" required>
        <option value="">Selecione uma rubrica...</option>
        <!-- opções preenchidas via JS -->
        <option value="__NOVA__">Solicitar cadastro de nova rubrica...</option>
      </select>
      <div id="rubricaDescricao" class="rubrica-desc"></div>

      <div id="avisoNovaRubrica" class="warning-box" style="display:none;">
        A rubrica desejada não está cadastrada no sistema.<br>
        Envie um e-mail para <strong>teko.pora@ifms.edu.br</strong> solicitando o cadastro, informando:
        <ul style="margin:5px 0 0 18px; padding:0;">
          <li>Descrição da rubrica;</li>
          <li>Tipo de despesa (ex.: bolsa, diária, material de consumo etc.);</li>
          <li>Justificativa da necessidade.</li>
        </ul>
        <p style="margin-top:5px;">
          Você pode utilizar este atalho:
          <br>
          <a id="linkNovaRubrica" href="#">
            Abrir e-mail para cadastro de nova rubrica
          </a>
        </p>
        <p style="margin-top:5px;">
          <strong>Observação:</strong> enquanto a rubrica não for cadastrada, a requisição não poderá ser concluída no sistema.
        </p>
      </div>
    </div>

    <!-- Exemplo de outros campos da requisição -->
    <div class="form-group">
      <label for="descricaoItens">Descrição dos itens / serviço</label>
      <textarea id="descricaoItens" name="descricaoItens" required></textarea>
    </div>

    <div class="form-group">
      <label for="valorEstimado">Valor estimado (R$)</label>
      <input type="number" id="valorEstimado" name="valorEstimado" step="0.01" min="0" required>
    </div>

    <button type="submit" class="btn btn-primary" id="btnSalvar">
      Salvar Requisição
    </button>
  </form>

  <script>
    // Carrega rubricas já cadastradas do localStorage
    function carregarRubricasNoFormulario() {
      const select = document.getElementById('rubricaSelect');
      const rubricaDescricao = document.getElementById('rubricaDescricao');

      const rubricasLocal = localStorage.getItem('rubricas');
      if (!rubricasLocal) {
        // Sem rubricas cadastradas
        rubricaDescricao.textContent = 'Nenhuma rubrica cadastrada no sistema. Solicite o cadastro por e-mail.';
        return;
      }

      /** rubricas é um objeto do tipo:
       *  {
       *    "33.90.18|Bolsa Estágio I": {
       *      rubrica: "33.90.18",
       *      descricao: "BOLSA",
       *      item: "Bolsa Estágio I",
       *      ...
       *    },
       *    ...
       *  }
       */
      let rubricas;
      try {
        rubricas = JSON.parse(rubricasLocal);
      } catch (e) {
        console.error('Erro ao ler rubricas do localStorage:', e);
        rubricaDescricao.textContent = 'Erro ao carregar rubricas. Solicite suporte.';
        return;
      }

      // Remove todas as opções (exceto a primeira e a de nova rubrica)
      const valorNova = '__NOVA__';
      const opNova = Array.from(select.options).find(opt => opt.value === valorNova);
      select.innerHTML = '<option value="">Selecione uma rubrica...</option>';
      if (opNova) {
        select.appendChild(opNova);
      } else {
        const optNova = document.createElement('option');
        optNova.value = valorNova;
        optNova.textContent = 'Solicitar cadastro de nova rubrica...';
        select.appendChild(optNova);
      }

      // Converte para array e ordena
      const lista = Object.values(rubricas).sort((a, b) => {
        if (a.rubrica !== b.rubrica) return a.rubrica.localeCompare(b.rubrica);
        return a.item.localeCompare(b.item);
      });

      lista.forEach(r => {
        const opt = document.createElement('option');
        opt.value = `${r.rubrica}|${r.item}`;
        opt.textContent = `${r.rubrica} - ${r.descricao} - ${r.item}`;
        opt.dataset.descricao = r.descricao;
        opt.dataset.item = r.item;
        select.insertBefore(opt, select.querySelector('option[value="__NOVA__"]'));
      });
    }

    function configurarEventosRubrica() {
      const select = document.getElementById('rubricaSelect');
      const descDiv = document.getElementById('rubricaDescricao');
      const avisoNova = document.getElementById('avisoNovaRubrica');
      const btnSalvar = document.getElementById('btnSalvar');
      const linkNovaRubrica = document.getElementById('linkNovaRubrica');

      select.addEventListener('change', () => {
        const valor = select.value;

        if (!valor) {
          descDiv.textContent = '';
          avisoNova.style.display = 'none';
          btnSalvar.disabled = false;
          return;
        }

        if (valor === '__NOVA__') {
          // Usuário quer rubrica não cadastrada
          descDiv.textContent = '';
          avisoNova.style.display = 'block';
          btnSalvar.disabled = true; // impede envio sem rubrica cadastrada

          // Prepara link mailto
          const assunto = encodeURIComponent('Cadastro de nova rubrica - Sistema Teko Porã');
          const corpo = encodeURIComponent(
            'Prezados(as),\n\n' +
            'Solicito o cadastro de nova rubrica para utilização no Sistema de Requisições do Projeto Teko Porã.\n\n' +
            'Dados sugeridos para a rubrica:\n' +
            '- Código da rubrica (se já existir na classificação orçamentária oficial):\n' +
            '- Descrição da rubrica:\n' +
            '- Tipo de despesa (ex.: bolsa, diárias, serviços, material de consumo etc.):\n' +
            '- Justificativa da necessidade:\n\n' +
            'Atenciosamente,\n'
          );
          linkNovaRubrica.href = `mailto:teko.pora@ifms.edu.br?subject=${assunto}&body=${corpo}`;
        } else {
          // Rubrica existente
          avisoNova.style.display = 'none';
          btnSalvar.disabled = false;

          const opt = select.options[select.selectedIndex];
          const descricao = opt.dataset.descricao || '';
          const item = opt.dataset.item || '';

          descDiv.textContent = `${descricao} - ${item}`;
        }
      });
    }

    function configurarEnvioFormulario() {
      const form = document.getElementById('formNovaRequisicao');
      const selectRubrica = document.getElementById('rubricaSelect');
      const btnSalvar = document.getElementById('btnSalvar');

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        if (selectRubrica.value === '__NOVA__') {
          alert('Para concluir a requisição, é necessário aguardar o cadastro da nova rubrica. Envie o pedido de cadastro para teko.pora@ifms.edu.br.');
          return;
        }

        if (!selectRubrica.value) {
          alert('Selecione uma rubrica.');
          return;
        }

        // Aqui você pode:
        // - enviar os dados para o Apps Script (google.script.run)
        // - ou gravar em localStorage, de acordo com sua arquitetura atual

        alert('Requisição salva (exemplo). Integre aqui com o backend / Apps Script.');
      });
    }

    window.onload = function() {
      carregarRubricasNoFormulario();
      configurarEventosRubrica();
      configurarEnvioFormulario();
    };
  </script>
</body>
</html>